unit_tests:
  - name: test_age_is_correct
    description: test that the user age_at_acquisition is calculated correctly
    model: dim_users
    given:
      - input: ref('stg_bingeflix__users')
        format: csv
        rows: |
          birthdate,created_at
          1941-10-01,2022-04-11T21:58:19
      - input: ref('stg_bingeflix__subscriptions')
        format: csv
        rows: |
          user_id,starts_at,subscription_id
          0,2022-04-11T21:58:19,0

    expect:
      format: csv
      rows: |
        age_at_acquisition
        80

  - name: test_current_age_is_correct
    description: test that the user current_age is calculated correctly
    model: dim_users
    given:
      - input: ref('stg_bingeflix__users')
        format: csv
        rows: |
          birthdate,created_at
          1941-10-01,2022-04-11T21:58:19
      - input: ref('stg_bingeflix__subscriptions')
        format: csv
        rows: |
          user_id,starts_at,subscription_id
          0,2022-04-11T21:58:19,0

    expect:
      format: csv
      rows: |
        current_age
        82

  - name: test_subscription_months_generated
    description: test that the subscription months generated correctly
    model: int_subscription_periods
    given:
      - input: ref('stg_bingeflix__subscriptions')
        format: csv
        rows: |
          subscription_id,user_id,starts_at,ends_at,subscription_plan_id
          139,58886,2019-01-08,2019-03-13,2
      - input: ref('stg_bingeflix__subscription_plans')
        format: csv
        rows: |
          plan_name,pricing,billing_period,subscription_plan_id
          Basic,0.10,monthly,2
      - input: ref('int_dates')
        format: csv
        rows: |
          calendar_date,day_of_month
          2019-01-01,1
          2019-02-01,1
          2019-03-01,1

    expect:
      format: csv
      rows: |
        date_month,user_id,subscription_id,mrr
        2019-01-01,58886,139,0.10
        2019-02-01,58886,139,0.10
